<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mom's Car Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            color: #1a1a1a;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Header - compact */
        .header {
            background: white;
            padding: 8px 16px;
            border-bottom: 1px solid #e5e5e5;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .header h1 { font-size: 18px; font-weight: 700; }
        .stats { display: flex; gap: 12px; font-size: 13px; color: #555; }
        .stats strong { color: #1a1a1a; }
        .filters { display: flex; gap: 6px; margin-left: auto; }
        .filter-btn {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #555;
        }
        .filter-btn:hover { background: #f5f5f5; }
        .filter-btn.active { background: #e8f4fd; border-color: #2196f3; color: #1976d2; }
        .sort-select {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }

        /* Layout */
        .layout { display: flex; height: calc(100vh - 50px); }
        .main { flex: 1; padding: 8px; overflow: auto; }
        .sidebar {
            width: 320px;
            background: white;
            border-left: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
        }
        #map { flex: 1; min-height: 200px; }
        .map-info { padding: 10px; font-size: 12px; color: #555; border-top: 1px solid #e5e5e5; }
        .selected-car { padding: 8px 10px; background: #f0f9ff; border-top: 1px solid #e5e5e5; font-size: 12px; }
        .selected-car .car-title { font-weight: 600; margin-bottom: 4px; }
        .selected-car .directions-btn {
            display: inline-block; background: #2563eb; color: white;
            padding: 4px 10px; border-radius: 4px; text-decoration: none; font-size: 11px;
        }

        /* Compact car cards */
        .cars { display: flex; flex-direction: column; gap: 6px; }
        .car-card {
            background: white;
            border-radius: 8px;
            padding: 10px 12px;
            display: grid;
            grid-template-columns: 80px 1fr auto auto;
            gap: 12px;
            align-items: center;
            border: 1px solid #e5e5e5;
            border-left: 4px solid #e5e5e5;
            cursor: pointer;
            transition: all 0.15s;
        }
        .car-card:hover { background: #fafafa; border-color: #ccc; }
        .car-card.saved { background: #fffef5; }
        .car-card.hidden { display: none; }
        .car-card.selected { border-color: #2563eb; background: #f0f7ff; }
        .car-card.great-deal { border-left-color: #22c55e; }
        .car-card.good-deal { border-left-color: #3b82f6; }
        .car-card.fair-deal { border-left-color: #f59e0b; }
        .car-card.over-budget { border-left-color: #ef4444; }
        .car-card.needs-review { border-left-color: #9ca3af; }

        /* Photo placeholder */
        .car-photo {
            width: 80px;
            height: 55px;
            border-radius: 6px;
            object-fit: cover;
            background: #f0f0f0;
        }

        /* Car info - compact */
        .car-info { min-width: 0; }
        .car-row1 { display: flex; align-items: baseline; gap: 8px; margin-bottom: 2px; }
        .car-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .car-dealer { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .official-badge { background: #e0f2fe; color: #0369a1; padding: 1px 5px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-left: 4px; }
        .car-row2 { display: flex; gap: 12px; font-size: 12px; color: #555; }
        .car-row2 strong { color: #1a1a1a; }
        .price-in { color: #16a34a; font-weight: 600; }
        .price-over { color: #dc2626; font-weight: 600; }
        .km-low { color: #2563eb; }
        .car-row3 { display: flex; gap: 4px; margin-top: 3px; flex-wrap: wrap; }
        .feat { background: #ecfdf5; color: #065f46; padding: 1px 5px; border-radius: 3px; font-size: 10px; }
        .carfax-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; display: inline-flex; align-items: center; gap: 3px; }
        .carfax-badge.clean { background: #dcfce7; color: #166534; }
        .carfax-badge.accident { background: #fef3c7; color: #92400e; }
        .carfax-badge.police { background: #fee2e2; color: #991b1b; }
        .carfax-badge.unknown { background: #f3f4f6; color: #6b7280; }
        .carfax-badge svg { width: 10px; height: 10px; }

        /* Deal badge */
        .deal-col { text-align: center; min-width: 70px; }
        .deal-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }
        .deal-badge.great { background: #dcfce7; color: #166534; }
        .deal-badge.good { background: #dbeafe; color: #1e40af; }
        .deal-badge.fair { background: #fef3c7; color: #92400e; }
        .deal-badge.over { background: #fee2e2; color: #991b1b; }
        .deal-badge.review { background: #f3f4f6; color: #4b5563; }

        /* Actions - compact */
        .car-actions { display: flex; gap: 4px; }
        .btn {
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            text-decoration: none;
            white-space: nowrap;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-aggregator { background: #6b7280; color: white; }
        .btn-secondary { background: white; border-color: #ddd; color: #555; }
        .btn-secondary:hover { background: #f5f5f5; }
        .btn-secondary.active { background: #fef3c7; border-color: #fbbf24; color: #92400e; }
        .btn-icon { padding: 5px 7px; font-size: 14px; }
        .btn-directions { background: #059669; color: white; }

        /* More actions dropdown */
        .more-menu { position: relative; }
        .more-btn { background: white; border: 1px solid #ddd; border-radius: 5px; padding: 5px 8px; cursor: pointer; font-size: 14px; }
        .more-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
            min-width: 120px;
        }
        .more-menu:hover .more-dropdown { display: block; }
        .more-dropdown a, .more-dropdown button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 12px;
            color: #333;
            text-decoration: none;
        }
        .more-dropdown a:hover, .more-dropdown button:hover { background: #f5f5f5; }
        .more-dropdown .danger { color: #dc2626; }

        /* Version */
        .version { position: fixed; bottom: 4px; left: 4px; font-size: 10px; color: #aaa; }

        /* Modal */
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-bg.show { display: flex; }
        .modal { background: white; border-radius: 10px; padding: 20px; width: 90%; max-width: 400px; }
        .modal h2 { font-size: 18px; margin-bottom: 12px; }
        .modal textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: none; margin-bottom: 12px; }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

        /* Mobile map toggle */
        .map-toggle {
            display: none;
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37,99,235,0.4);
            z-index: 1000;
        }

        /* Mobile */
        @media (max-width: 900px) {
            .map-toggle { display: flex; align-items: center; gap: 6px; }
            .sidebar {
                display: none;
                position: fixed;
                inset: 0;
                width: 100%;
                z-index: 999;
            }
            .sidebar.show { display: flex; flex-direction: column; }
            .sidebar .map-close {
                position: absolute;
                top: 12px;
                right: 12px;
                background: white;
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                font-size: 20px;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 1001;
            }
        }
        @media (max-width: 768px) {
            .header { padding: 6px 10px; gap: 8px; }
            .header h1 { font-size: 16px; }
            .stats { font-size: 11px; gap: 8px; }
            .filter-btn, .sort-select { padding: 4px 8px; font-size: 11px; }
            .main { padding: 6px; }
            .car-card { grid-template-columns: 60px 1fr auto; gap: 8px; padding: 8px; }
            .car-photo { width: 60px; height: 45px; }
            .car-name { font-size: 13px; }
            .car-dealer { font-size: 11px; }
            .car-row2 { font-size: 11px; gap: 8px; }
            .car-row3 { display: none; }
            .deal-col { display: none; }
            .car-actions { gap: 3px; }
            .btn { padding: 5px 8px; font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="version">v5.0</div>

    <div class="header">
        <h1>Mom's Car Finder</h1>
        <div class="stats">
            <span><strong id="s-total">0</strong> cars</span>
            <span><strong id="s-budget">0</strong> in budget</span>
            <span><strong id="s-clean">0</strong> clean</span>
        </div>
        <div class="filters">
            <select class="sort-select" id="sort" onchange="render()">
                <option value="score">Best Match</option>
                <option value="price">Price</option>
                <option value="km">Mileage</option>
                <option value="dist">Distance</option>
            </select>
            <button class="filter-btn" id="f-fav" onclick="toggle('fav')">Saved</button>
            <button class="filter-btn" id="f-budget" onclick="toggle('budget')">In Budget</button>
            <button class="filter-btn" id="f-clean" onclick="toggle('clean')">Clean</button>
        </div>
    </div>

    <div class="layout">
        <div class="main">
            <div class="cars" id="cars"></div>
        </div>
        <button class="map-toggle" onclick="toggleMap()">Map</button>
        <div class="sidebar">
            <button class="map-close" onclick="toggleMap()">&times;</button>
            <div id="map"></div>
            <div id="selected-car-info" class="selected-car" style="display:none;">
                <div class="car-title" id="selected-title"></div>
                <a id="directions-link" href="#" target="_blank" class="directions-btn">Get Directions</a>
            </div>
            <div class="map-info">
                <strong>Budget:</strong> $21K total | <strong>Home:</strong> 299 Mullen Dr, Thornhill
            </div>
        </div>
    </div>

    <div class="modal-bg" id="note-modal">
        <div class="modal">
            <h2>Your Notes</h2>
            <textarea id="note-text" placeholder="Write your notes about this car..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideNoteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNoteModal()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://bjswbajtxacjwubghytb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqc3diYWp0eGFjand1YmdoeXRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNjIxODYsImV4cCI6MjA4MjYzODE4Nn0.tQvzTXf3xft07Wrv8dB0lG2DaIS1UQNCuz5vVB6fTT4';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const HOME_COORDS = [43.8108, -79.4250];
        const HOME_ADDRESS = '299 Mullen Dr, Thornhill, ON';

        let cars = [], favs = new Set(), notes = {}, filters = {}, editingNoteId = null;
        let map, routeLayer, selectedCarId = null;

        const toggleMap = () => {
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.querySelector('.map-toggle');
            const isShowing = sidebar.classList.toggle('show');
            if (toggleBtn) toggleBtn.style.display = isShowing ? 'none' : '';
            if (isShowing && map) setTimeout(() => map.invalidateSize(), 100);
        };

        const icons = {
            check: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>`,
            warn: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h.01"/></svg>`,
            x: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>`,
            q: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 16h.01M12 12a2 2 0 10-2-2"/></svg>`
        };

        const getPhoto = c => {
            const isSoul = c.model.includes('Soul');
            const isKicks = c.model.includes('Kicks');
            const brand = isSoul ? 'Kia' : isKicks ? 'Nissan' : 'Hyundai';
            const model = isSoul ? 'Soul' : isKicks ? 'Kicks' : 'Venue';
            const bg = isSoul ? '#2c5282' : isKicks ? '#c41230' : '#1e3a5f';
            return `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 110"><rect fill="${bg}" width="160" height="110" rx="6"/><text x="80" y="40" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">${c.year} ${brand}</text><text x="80" y="60" text-anchor="middle" font-family="system-ui" font-size="14" font-weight="700" fill="white">${model}</text><text x="80" y="80" text-anchor="middle" font-family="system-ui" font-size="10" fill="rgba(255,255,255,0.7)">${c.color || ''}</text></svg>`)}`;
        };

        const feat = { 'htd-seats': 'Heated', 'htd-wheel': 'Htd Wheel', 'camera': 'Camera', 'blind-spot': 'BSM', 'lane': 'Lane', 'auto-brake': 'AEB' };

        const getCarName = c => {
            const isSoul = c.model.includes('Soul'), isKicks = c.model.includes('Kicks');
            const m = isSoul ? 'Soul' : isKicks ? 'Kicks' : 'Venue';
            let t = '';
            if (c.model.includes('EX+')) t = 'EX+';
            else if (c.model.includes('EX')) t = 'EX';
            else if (c.model.includes('Ultimate')) t = 'Ult';
            else if (c.model.includes('Preferred')) t = 'Pref';
            else if (c.model.includes('Trend')) t = 'Trend';
            else if (c.model.includes('Essential')) t = 'Ess';
            else if (c.model.includes('SR')) t = 'SR';
            else if (c.model.includes('SV')) t = 'SV';
            let col = c.color && c.color !== 'Unknown' ? c.color.split('/')[0].split(' ')[0] : '';
            return `${c.year} ${m} ${t}${col ? ' ' + col : ''}`;
        };

        const getShortName = c => {
            const isSoul = c.model.includes('Soul'), isKicks = c.model.includes('Kicks');
            return `${c.year} ${isSoul ? 'Soul' : isKicks ? 'Kicks' : 'Venue'}`;
        };

        const isDealerLink = url => url && !['autotrader.ca', 'carpages.ca', 'kijiji.', 'cargurus.', 'clutch.ca'].some(a => url.includes(a));
        const getSiteName = url => {
            if (!url) return '';
            if (url.includes('autotrader')) return 'AutoTrader';
            if (url.includes('clutch')) return 'Clutch';
            try { return new URL(url).hostname.replace('www.','').split('.')[0]; } catch { return 'Dealer'; }
        };
        const getDirectionsUrl = (d, a) => `https://www.google.com/maps/dir/${encodeURIComponent(HOME_ADDRESS)}/${encodeURIComponent((a||d) + ', Ontario, Canada')}`;

        const score = c => {
            let s = Math.min(5, (c.features||[]).length);
            s += c.km < 30000 ? 5 : c.km < 50000 ? 4 : c.km < 65000 ? 3 : c.km < 80000 ? 2 : 1;
            s += c.carfax === 'clean' ? 5 : c.carfax === 'unknown' ? 3 : 1;
            const allIn = c.price * 1.13;
            s += allIn < 18000 ? 5 : allIn < 20000 ? 4 : allIn < 21000 ? 3 : allIn < 22500 ? 2 : 1;
            s += c.distance < 20 ? 5 : c.distance < 50 ? 4 : c.distance < 100 ? 3 : 2;
            return s;
        };

        const getDeal = (c, s) => {
            if (c.carfax === 'police') return { cls: 'needs-review', badge: 'review', label: 'Review' };
            if (c.carfax === 'accident') return { cls: 'fair-deal', badge: 'fair', label: 'Accident' };
            if (c.price * 1.13 > 21000) return { cls: 'over-budget', badge: 'over', label: 'Over Budget' };
            if (s >= 18) return { cls: 'great-deal', badge: 'great', label: 'Great Deal' };
            if (s >= 15) return { cls: 'good-deal', badge: 'good', label: 'Good' };
            return { cls: 'fair-deal', badge: 'fair', label: 'Fair' };
        };

        const getCarfax = cf => {
            if (cf === 'clean') return { cls: 'clean', icon: icons.check, label: 'Clean' };
            if (cf === 'accident') return { cls: 'accident', icon: icons.warn, label: 'Accident' };
            if (cf === 'police') return { cls: 'police', icon: icons.x, label: 'Police' };
            return { cls: 'unknown', icon: icons.q, label: 'Unknown' };
        };

        const selectCar = id => {
            selectedCarId = id;
            const c = cars.find(car => car.id === id);
            if (!c) return;
            document.querySelectorAll('.car-card').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.car-card[data-id="${id}"]`)?.classList.add('selected');
            document.getElementById('selected-title').textContent = `${getCarName(c)} - ${c.dealer}`;
            document.getElementById('directions-link').href = getDirectionsUrl(c.dealer, c.address);
            document.getElementById('selected-car-info').style.display = 'block';
            if (c.coords && map) {
                const sidebar = document.querySelector('.sidebar');
                if (window.innerWidth <= 900 && !sidebar.classList.contains('show')) sidebar.classList.add('show');
                setTimeout(() => {
                    map.invalidateSize();
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.polyline([HOME_COORDS, c.coords], { color: '#2563eb', weight: 3, dashArray: '8,8' }).addTo(map);
                    map.fitBounds(L.latLngBounds([HOME_COORDS, c.coords]), { padding: [40, 40] });
                }, 100);
            }
        };

        const render = () => {
            const sortBy = document.getElementById('sort').value;
            let list = [...cars];
            if (sortBy === 'score') list.sort((a, b) => score(b) - score(a));
            else if (sortBy === 'price') list.sort((a, b) => a.price - b.price);
            else if (sortBy === 'km') list.sort((a, b) => a.km - b.km);
            else if (sortBy === 'dist') list.sort((a, b) => a.distance - b.distance);

            document.getElementById('cars').innerHTML = list.map(c => {
                const s = score(c);
                const allIn = c.price * 1.13;
                const allInK = (allIn / 1000).toFixed(1);
                const over = allIn > 21000;
                const fav = favs.has(c.id);
                const hide = (filters.fav && !fav) || (filters.budget && over) || (filters.clean && c.carfax !== 'clean');
                const deal = getDeal(c, s);
                const cfx = getCarfax(c.carfax);
                const feats = (c.features || []).filter(f => feat[f]).slice(0, 4);
                const url = c.dealerUrl || c.listingUrl;
                const isD = c.dealerUrl || isDealerLink(c.listingUrl);
                const site = isD ? c.dealer.split(' ')[0] : getSiteName(c.listingUrl);

                return `
                <div class="car-card ${deal.cls} ${fav ? 'saved' : ''} ${hide ? 'hidden' : ''} ${selectedCarId === c.id ? 'selected' : ''}" data-id="${c.id}" onclick="selectCar(${c.id})">
                    <img class="car-photo" src="${getPhoto(c)}" alt="">
                    <div class="car-info">
                        <div class="car-row1">
                            <span class="car-name">${getCarName(c)}</span>
                            <span class="car-dealer">${c.dealer}${c.official ? '<span class="official-badge">Official</span>' : ''}</span>
                        </div>
                        <div class="car-row2">
                            <span class="${over ? 'price-over' : 'price-in'}">$${allInK}K</span>
                            <span class="${c.km < 30000 ? 'km-low' : ''}">${Math.round(c.km/1000)}K km</span>
                            <span>${c.distance}km away</span>
                            <span class="carfax-badge ${cfx.cls}">${cfx.icon}${cfx.label}</span>
                        </div>
                        <div class="car-row3">
                            ${feats.map(f => `<span class="feat">${feat[f]}</span>`).join('')}
                        </div>
                    </div>
                    <div class="deal-col"><span class="deal-badge ${deal.badge}">${deal.label}</span></div>
                    <div class="car-actions" onclick="event.stopPropagation()">
                        ${url ? `<a href="${url}" target="_blank" class="btn ${isD ? 'btn-primary' : 'btn-aggregator'}">${site}</a>` : ''}
                        <a href="${getDirectionsUrl(c.dealer, c.address)}" target="_blank" class="btn btn-directions">Go</a>
                        <div class="more-menu">
                            <button class="more-btn">...</button>
                            <div class="more-dropdown">
                                <button onclick="toggleFav(${c.id})">${fav ? 'Unsave' : 'Save'}</button>
                                <button onclick="showNoteModal(${c.id})">Notes</button>
                                ${c.carfaxUrl ? `<a href="${c.carfaxUrl}" target="_blank">CARFAX</a>` : ''}
                                <button class="danger" onclick="del(${c.id})">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('s-total').textContent = cars.length;
            document.getElementById('s-budget').textContent = cars.filter(c => c.price * 1.13 <= 21000).length;
            document.getElementById('s-clean').textContent = cars.filter(c => c.carfax === 'clean').length;
        };

        const toggle = t => { filters[t] = !filters[t]; document.getElementById(`f-${t}`).classList.toggle('active', filters[t]); render(); };
        const toggleFav = async id => {
            if (favs.has(id)) { favs.delete(id); await db.from('favorites').delete().eq('car_id', id); }
            else { favs.add(id); await db.from('favorites').insert({ car_id: id }); }
            render();
        };
        const showNoteModal = id => { editingNoteId = id; document.getElementById('note-text').value = notes[id] || ''; document.getElementById('note-modal').classList.add('show'); };
        const hideNoteModal = () => document.getElementById('note-modal').classList.remove('show');
        const saveNoteModal = async () => {
            notes[editingNoteId] = document.getElementById('note-text').value;
            await db.from('notes').upsert({ car_id: editingNoteId, note: notes[editingNoteId] }, { onConflict: 'car_id' });
            hideNoteModal(); render();
        };
        const del = async id => { if (confirm('Remove?')) { await db.from('cars').delete().eq('id', id); cars = cars.filter(c => c.id !== id); render(); } };

        const initMap = () => {
            map = L.map('map', { zoomControl: false }).setView(HOME_COORDS, 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.circleMarker(HOME_COORDS, { radius: 10, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 1, weight: 2 }).addTo(map).bindPopup('<b>Home</b>');
            cars.forEach(c => {
                if (c.coords) {
                    const col = c.carfax === 'clean' ? '#22c55e' : c.carfax === 'police' ? '#ef4444' : c.carfax === 'accident' ? '#f59e0b' : '#9ca3af';
                    L.circleMarker(c.coords, { radius: 6, color: col, fillColor: col, fillOpacity: 0.9, weight: 0 })
                        .addTo(map).bindPopup(`<b>${getShortName(c)}</b><br>$${c.price.toLocaleString()}`).on('click', () => selectCar(c.id));
                }
            });
        };

        const mapCar = c => ({ id: c.id, year: c.year, model: c.model, color: c.color, km: c.km, price: c.price, dealer: c.dealer, distance: c.distance, features: c.features || [], carfax: c.carfax, carfaxUrl: c.carfax_url, listingUrl: c.listing_url, dealerUrl: c.dealer_url, address: c.address, coords: c.coords, official: c.official });

        (async () => {
            try {
                const [carsRes, favsRes, notesRes] = await Promise.all([
                    db.from('cars').select('*'),
                    db.from('favorites').select('car_id'),
                    db.from('notes').select('car_id, note')
                ]);
                cars = (carsRes.data || []).map(mapCar);
                favs = new Set((favsRes.data || []).map(f => f.car_id));
                notes = (notesRes.data || []).reduce((a, n) => { a[n.car_id] = n.note; return a; }, {});
            } catch (e) { console.error(e); }
            render();
            initMap();
        })();
    </script>
</body>
</html>
