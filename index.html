<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mom's Car Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            color: #1a1a1a;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Header - compact */
        .header {
            background: white;
            padding: 8px 16px;
            border-bottom: 1px solid #e5e5e5;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .header h1 { font-size: 18px; font-weight: 700; }
        .stats { display: flex; gap: 12px; font-size: 13px; color: #555; }
        .stats strong { color: #1a1a1a; }
        .filters { display: flex; gap: 6px; margin-left: auto; }
        .filter-btn {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #555;
        }
        .filter-btn:hover { background: #f5f5f5; }
        .filter-btn.active { background: #e8f4fd; border-color: #2196f3; color: #1976d2; }
        .sort-select {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }

        /* Layout */
        .layout { display: flex; height: calc(100vh - 50px); }
        .main { flex: 1; padding: 8px; overflow: auto; }
        .sidebar {
            width: 320px;
            background: white;
            border-left: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
        }
        #map { flex: 1; min-height: 200px; }
        .map-info { padding: 10px; font-size: 12px; color: #555; border-top: 1px solid #e5e5e5; }
        .selected-car { padding: 12px; background: #f0f9ff; border-top: 1px solid #e5e5e5; font-size: 13px; }
        .selected-car .car-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .selected-car .dealer-name { font-weight: 500; color: #333; margin-bottom: 2px; }
        .selected-car .dealer-addr { color: #666; font-size: 12px; margin-bottom: 6px; }
        .selected-car .dealer-dist { color: #059669; font-size: 12px; font-weight: 500; margin-bottom: 8px; }
        .selected-car .directions-btn {
            display: inline-block; background: #059669; color: white;
            padding: 8px 14px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 500;
        }
        .selected-car .directions-btn:hover { background: #047857; }

        /* Car cards - larger for seniors */
        .cars { display: flex; flex-direction: column; gap: 10px; }
        .car-card {
            background: white;
            border-radius: 10px;
            padding: 14px 16px;
            border: 2px solid #e5e5e5;
            border-left: 5px solid #e5e5e5;
            cursor: pointer;
            transition: all 0.15s;
        }
        .car-card:hover { background: #fafafa; border-color: #ccc; }
        .car-card.saved { background: #fffbeb; border-color: #fbbf24; }
        .car-card.hidden { display: none; }
        .car-card.selected { border-color: #2563eb; background: #eff6ff; }
        .car-card.great-deal { border-left-color: #22c55e; }
        .car-card.good-deal { border-left-color: #3b82f6; }
        .car-card.fair-deal { border-left-color: #f59e0b; }
        .car-card.over-budget { border-left-color: #ef4444; }
        .car-card.needs-review { border-left-color: #9ca3af; }
        .car-card-main {
            display: grid;
            grid-template-columns: 90px 1fr auto;
            gap: 14px;
            align-items: center;
        }

        /* Photo placeholder */
        .car-photo {
            width: 90px;
            height: 62px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
        }

        /* Car info - larger text for seniors */
        .car-info { min-width: 0; }
        .car-row1 { display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px; flex-wrap: wrap; }
        .car-name { font-size: 17px; font-weight: 700; }
        .car-dealer { font-size: 14px; color: #555; }
        .official-badge { background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 4px; }
        .car-row2 { display: flex; gap: 16px; font-size: 15px; color: #444; margin-bottom: 4px; flex-wrap: wrap; }
        .car-row2 strong { color: #1a1a1a; }
        .price-in { color: #16a34a; font-weight: 700; font-size: 17px; }
        .price-over { color: #dc2626; font-weight: 700; font-size: 17px; }
        .km-low { color: #2563eb; font-weight: 600; }
        .car-row3 { display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; }
        .feat { background: #ecfdf5; color: #065f46; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .carfax-badge { padding: 3px 8px; border-radius: 5px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .carfax-badge.clean { background: #dcfce7; color: #166534; }
        .carfax-badge.accident { background: #fef3c7; color: #92400e; }
        .carfax-badge.police { background: #fee2e2; color: #991b1b; }
        .carfax-badge.unknown { background: #f3f4f6; color: #6b7280; }
        .carfax-badge svg { width: 12px; height: 12px; }

        /* Notes section - always visible */
        .car-notes {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e5e5;
        }
        .note-display {
            background: #fefce8;
            border: 1px solid #fef08a;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 14px;
            color: #713f12;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }
        .note-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
            resize: none;
            min-height: 60px;
            font-family: inherit;
        }
        .note-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .note-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        /* Status indicator */
        .car-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
            color: #666;
        }
        .status-saved {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
        }

        /* Deal badge */
        .deal-col { text-align: center; min-width: 70px; }
        .deal-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; }
        .deal-badge.great { background: #dcfce7; color: #166534; }
        .deal-badge.good { background: #dbeafe; color: #1e40af; }
        .deal-badge.fair { background: #fef3c7; color: #92400e; }
        .deal-badge.over { background: #fee2e2; color: #991b1b; }
        .deal-badge.review { background: #f3f4f6; color: #4b5563; }

        /* Actions - larger buttons for seniors */
        .car-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            text-decoration: none;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-listing { background: #2563eb; color: white; }
        .btn-listing:hover { background: #1d4ed8; }
        .btn-save { background: white; border-color: #fbbf24; color: #92400e; }
        .btn-save.active { background: #fef3c7; }
        .btn-carfax { background: #059669; color: white; }
        .btn-directions { background: #7c3aed; color: white; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: #fee2e2; color: #dc2626; border-color: #fecaca; }

        /* Version */
        .version { position: fixed; bottom: 4px; left: 4px; font-size: 10px; color: #aaa; }

        /* Modal */
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-bg.show { display: flex; }
        .modal { background: white; border-radius: 10px; padding: 20px; width: 90%; max-width: 400px; }
        .modal h2 { font-size: 18px; margin-bottom: 12px; }
        .modal textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: none; margin-bottom: 12px; }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

        /* Mobile map toggle */
        .map-toggle {
            display: none;
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37,99,235,0.4);
            z-index: 1000;
        }

        /* Mobile */
        @media (max-width: 900px) {
            .map-toggle { display: flex; align-items: center; gap: 6px; }
            .sidebar {
                display: none;
                position: fixed;
                inset: 0;
                width: 100%;
                z-index: 999;
            }
            .sidebar.show { display: flex; flex-direction: column; }
            .sidebar .map-close {
                position: absolute;
                top: 12px;
                right: 12px;
                background: white;
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                font-size: 20px;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 1001;
            }
        }
        @media (max-width: 768px) {
            .header { padding: 8px 12px; gap: 8px; }
            .header h1 { font-size: 16px; }
            .stats { font-size: 12px; gap: 8px; }
            .filter-btn, .sort-select { padding: 6px 10px; font-size: 12px; }
            .main { padding: 8px; }
            .car-card { padding: 12px; }
            .car-card-main { grid-template-columns: 70px 1fr; gap: 10px; }
            .car-photo { width: 70px; height: 48px; }
            .car-name { font-size: 15px; }
            .car-dealer { font-size: 13px; }
            .car-row2 { font-size: 13px; gap: 10px; }
            .car-actions { margin-top: 10px; }
            .btn { padding: 10px 14px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="version">v7.1</div>

    <div class="header">
        <h1>Mom's Car Finder</h1>
        <div class="stats">
            <span><strong id="s-total">0</strong> cars</span>
            <span><strong id="s-budget">0</strong> in budget</span>
            <span><strong id="s-clean">0</strong> clean</span>
        </div>
        <div class="filters">
            <button class="filter-btn" style="background:#22c55e;color:white;border-color:#22c55e;" onclick="openAddModal()">+ Add Car</button>
            <select class="sort-select" id="sort" onchange="render()">
                <option value="pricedist">Price + Distance</option>
                <option value="score">Best Match</option>
                <option value="price">Price</option>
                <option value="km">Mileage</option>
                <option value="dist">Distance</option>
            </select>
            <button class="filter-btn" id="f-fav" onclick="toggle('fav')">Saved</button>
            <button class="filter-btn" id="f-budget" onclick="toggle('budget')">In Budget</button>
            <button class="filter-btn" id="f-clean" onclick="toggle('clean')">Clean</button>
        </div>
    </div>

    <!-- Add/Edit Car Modal -->
    <div class="modal-bg" id="car-modal">
        <div class="modal" style="max-width:500px;">
            <h2 id="modal-title">Add New Car</h2>
            <div style="display:grid;gap:12px;">
                <div>
                    <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Listing URL (optional)</label>
                    <input type="url" id="car-url" placeholder="https://dealer.com/listing..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                </div>
                <div style="display:grid;grid-template-columns:1fr 2fr;gap:8px;">
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Year*</label>
                        <input type="number" id="car-year" placeholder="2022" min="2010" max="2025" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Model*</label>
                        <select id="car-model" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                            <option value="">Select model...</option>
                            <option value="Soul EX">Soul EX</option>
                            <option value="Soul EX+">Soul EX+</option>
                            <option value="Soul EV">Soul EV</option>
                            <option value="Soul LX">Soul LX</option>
                            <option value="Soul GT-Line">Soul GT-Line</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Price (before tax)*</label>
                        <input type="number" id="car-price" placeholder="16999" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Kilometers*</label>
                        <input type="number" id="car-km" placeholder="50000" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                    </div>
                </div>
                <div>
                    <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Dealer Name*</label>
                    <input type="text" id="car-dealer" placeholder="Dealer Name" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                </div>
                <div>
                    <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Dealer Address</label>
                    <input type="text" id="car-address" placeholder="123 Main St, Toronto, ON" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Distance (km)</label>
                        <input type="number" id="car-distance" placeholder="25" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Color</label>
                        <input type="text" id="car-color" placeholder="Black" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">CARFAX Status</label>
                        <select id="car-carfax" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                            <option value="unknown">Unknown</option>
                            <option value="clean">Clean - No Accidents</option>
                            <option value="accident">Has Accident</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Official Dealer?</label>
                        <select id="car-official" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                            <option value="true">Yes - Official Dealer</option>
                            <option value="false">No - Used Car Lot</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">Notes (VIN, Stock #, Features, etc.)</label>
                    <textarea id="car-notes" placeholder="VIN: ABC123..., Stock #1234, Certified, Blind Spot, etc." style="width:100%;height:60px;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;resize:none;"></textarea>
                </div>
            </div>
            <div class="modal-actions" style="margin-top:16px;">
                <button class="btn btn-small" style="background:#f3f4f6;color:#374151;" onclick="closeModal()">Cancel</button>
                <button class="btn btn-small btn-listing" onclick="saveCar()">Save Car</button>
            </div>
        </div>
    </div>

    <div class="layout">
        <div class="main">
            <div class="cars" id="cars"></div>
        </div>
        <button class="map-toggle" onclick="toggleMap()">Map</button>
        <div class="sidebar">
            <button class="map-close" onclick="toggleMap()">&times;</button>
            <div id="map"></div>
            <div id="selected-car-info" class="selected-car" style="display:none;">
                <div class="car-title" id="selected-title"></div>
                <div class="dealer-name" id="selected-dealer"></div>
                <div class="dealer-addr" id="selected-addr"></div>
                <div class="dealer-dist" id="selected-dist"></div>
                <a id="directions-link" href="#" target="_blank" class="directions-btn">Get Directions from Home</a>
            </div>
            <div class="map-info">
                <strong>Budget:</strong> $21K total | <strong>Home:</strong> 299 Mullen Dr, Thornhill
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://bjswbajtxacjwubghytb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqc3diYWp0eGFjand1YmdoeXRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNjIxODYsImV4cCI6MjA4MjYzODE4Nn0.tQvzTXf3xft07Wrv8dB0lG2DaIS1UQNCuz5vVB6fTT4';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const HOME_COORDS = [43.8108, -79.4250];
        const HOME_ADDRESS = '299 Mullen Dr, Thornhill, ON';

        let cars = [], favs = new Set(), notes = {}, filters = {}, editingNoteId = null;
        let map, routeLayer, selectedCarId = null;

        const toggleMap = () => {
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.querySelector('.map-toggle');
            const isShowing = sidebar.classList.toggle('show');
            if (toggleBtn) toggleBtn.style.display = isShowing ? 'none' : '';
            if (isShowing && map) setTimeout(() => map.invalidateSize(), 100);
        };

        const icons = {
            check: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>`,
            warn: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v4m0 4h.01"/></svg>`,
            x: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>`,
            q: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 16h.01M12 12a2 2 0 10-2-2"/></svg>`
        };

        const getPhoto = c => {
            const isSoul = c.model.includes('Soul');
            const isKicks = c.model.includes('Kicks');
            const brand = isSoul ? 'Kia' : isKicks ? 'Nissan' : 'Hyundai';
            const model = isSoul ? 'Soul' : isKicks ? 'Kicks' : 'Venue';
            const bg = isSoul ? '#2c5282' : isKicks ? '#c41230' : '#1e3a5f';
            return `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 110"><rect fill="${bg}" width="160" height="110" rx="6"/><text x="80" y="40" text-anchor="middle" font-family="system-ui" font-size="12" font-weight="600" fill="white">${c.year} ${brand}</text><text x="80" y="60" text-anchor="middle" font-family="system-ui" font-size="14" font-weight="700" fill="white">${model}</text><text x="80" y="80" text-anchor="middle" font-family="system-ui" font-size="10" fill="rgba(255,255,255,0.7)">${c.color || ''}</text></svg>`)}`;
        };

        const feat = { 'htd-seats': 'Heated', 'htd-wheel': 'Htd Wheel', 'camera': 'Camera', 'blind-spot': 'BSM', 'lane': 'Lane', 'auto-brake': 'AEB' };

        const getCarName = c => {
            const isSoul = c.model.includes('Soul'), isKicks = c.model.includes('Kicks');
            const m = isSoul ? 'Soul' : isKicks ? 'Kicks' : 'Venue';
            let t = '';
            if (c.model.includes('EX+')) t = 'EX+';
            else if (c.model.includes('EX')) t = 'EX';
            else if (c.model.includes('Ultimate')) t = 'Ult';
            else if (c.model.includes('Preferred')) t = 'Pref';
            else if (c.model.includes('Trend')) t = 'Trend';
            else if (c.model.includes('Essential')) t = 'Ess';
            else if (c.model.includes('SR')) t = 'SR';
            else if (c.model.includes('SV')) t = 'SV';
            let col = c.color && c.color !== 'Unknown' ? c.color.split('/')[0].split(' ')[0] : '';
            return `${c.year} ${m} ${t}${col ? ' ' + col : ''}`;
        };

        const getShortName = c => {
            const isSoul = c.model.includes('Soul'), isKicks = c.model.includes('Kicks');
            return `${c.year} ${isSoul ? 'Soul' : isKicks ? 'Kicks' : 'Venue'}`;
        };

        const isDealerLink = url => url && !['autotrader.ca', 'carpages.ca', 'kijiji.', 'cargurus.', 'clutch.ca'].some(a => url.includes(a));
        const getSiteName = url => {
            if (!url) return '';
            if (url.includes('autotrader')) return 'AutoTrader';
            if (url.includes('clutch')) return 'Clutch';
            try { return new URL(url).hostname.replace('www.','').split('.')[0]; } catch { return 'Dealer'; }
        };
        // Shorten dealer name for button but keep it clear
        const getDealerBtnText = (dealer) => {
            // Common shortenings
            const short = dealer
                .replace('Richmond Hill', 'RH')
                .replace('Brampton North', 'Brampton N.')
                .replace('Golden Mile', 'Golden Mi.')
                .replace('Frontier Fine Cars', 'Frontier Cars')
                .replace('Autorama Toronto', 'Autorama')
                .replace('Limitless Auto Sales', 'Limitless Auto')
                .replace('Boyer Hyundai Pickering', 'Boyer Pickering');
            return short.length > 18 ? short.substring(0, 16) + '...' : short;
        };
        const getDirectionsUrl = (d, a) => `https://www.google.com/maps/dir/${encodeURIComponent(HOME_ADDRESS)}/${encodeURIComponent((a||d) + ', Ontario, Canada')}`;

        const score = c => {
            let s = Math.min(5, (c.features||[]).length);
            s += c.km < 30000 ? 5 : c.km < 50000 ? 4 : c.km < 65000 ? 3 : c.km < 80000 ? 2 : 1;
            s += c.carfax === 'clean' ? 5 : c.carfax === 'unknown' ? 3 : 1;
            const allIn = c.price * 1.13;
            s += allIn < 18000 ? 5 : allIn < 20000 ? 4 : allIn < 21000 ? 3 : allIn < 22500 ? 2 : 1;
            s += c.distance < 20 ? 5 : c.distance < 50 ? 4 : c.distance < 100 ? 3 : 2;
            return s;
        };

        const getDeal = (c, s) => {
            if (c.carfax === 'police') return { cls: 'needs-review', badge: 'review', label: 'Review' };
            if (c.carfax === 'accident') return { cls: 'fair-deal', badge: 'fair', label: 'Accident' };
            if (c.price * 1.13 > 21000) return { cls: 'over-budget', badge: 'over', label: 'Over Budget' };
            if (s >= 18) return { cls: 'great-deal', badge: 'great', label: 'Great Deal' };
            if (s >= 15) return { cls: 'good-deal', badge: 'good', label: 'Good' };
            return { cls: 'fair-deal', badge: 'fair', label: 'Fair' };
        };

        const getCarfax = cf => {
            if (cf === 'clean') return { cls: 'clean', icon: icons.check, label: 'Clean' };
            if (cf === 'accident') return { cls: 'accident', icon: icons.warn, label: 'Accident' };
            if (cf === 'police') return { cls: 'police', icon: icons.x, label: 'Police' };
            return { cls: 'unknown', icon: icons.q, label: 'Unknown' };
        };

        const selectCar = id => {
            selectedCarId = id;
            const c = cars.find(car => car.id === id);
            if (!c) return;
            document.querySelectorAll('.car-card').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.car-card[data-id="${id}"]`)?.classList.add('selected');

            // Update info panel
            document.getElementById('selected-title').textContent = getCarName(c);
            document.getElementById('selected-dealer').textContent = c.dealer;
            document.getElementById('selected-addr').textContent = c.address || 'Address not available';
            document.getElementById('selected-dist').textContent = `${c.distance} km from home`;
            document.getElementById('directions-link').href = getDirectionsUrl(c.dealer, c.address);
            document.getElementById('selected-car-info').style.display = 'block';

            if (c.coords && map) {
                const sidebar = document.querySelector('.sidebar');
                const toggleBtn = document.querySelector('.map-toggle');
                if (window.innerWidth <= 900 && !sidebar.classList.contains('show')) {
                    sidebar.classList.add('show');
                    if (toggleBtn) toggleBtn.style.display = 'none';
                }
                setTimeout(() => {
                    map.invalidateSize();
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.polyline([HOME_COORDS, c.coords], { color: '#2563eb', weight: 4, opacity: 0.8 }).addTo(map);
                    map.fitBounds(L.latLngBounds([HOME_COORDS, c.coords]), { padding: [50, 50] });
                }, 100);
            }
        };

        const render = () => {
            const sortBy = document.getElementById('sort').value;
            let list = [...cars];
            const priceBucket = p => {
                const allIn = p * 1.13;
                if (allIn <= 19000) return 0;
                if (allIn <= 21000) return 1;
                return 2;
            };
            if (sortBy === 'pricedist') list.sort((a, b) => priceBucket(a.price) - priceBucket(b.price) || a.distance - b.distance);
            else if (sortBy === 'score') list.sort((a, b) => score(b) - score(a));
            else if (sortBy === 'price') list.sort((a, b) => a.price - b.price);
            else if (sortBy === 'km') list.sort((a, b) => a.km - b.km);
            else if (sortBy === 'dist') list.sort((a, b) => a.distance - b.distance);

            document.getElementById('cars').innerHTML = list.map(c => {
                const s = score(c);
                const allIn = c.price * 1.13;
                const allInK = (allIn / 1000).toFixed(1);
                const over = allIn > 21000;
                const fav = favs.has(c.id);
                const note = notes[c.id] || '';
                const hide = (filters.fav && !fav) || (filters.budget && over) || (filters.clean && c.carfax !== 'clean');
                const deal = getDeal(c, s);
                const cfx = getCarfax(c.carfax);
                const feats = (c.features || []).filter(f => feat[f]);
                // Prioritize actual listing URL over dealer homepage
                const listingUrl = c.listingUrl;
                const dealerUrl = c.dealerUrl;

                return `
                <div class="car-card ${deal.cls} ${fav ? 'saved' : ''} ${hide ? 'hidden' : ''} ${selectedCarId === c.id ? 'selected' : ''}" data-id="${c.id}" onclick="selectCar(${c.id})">
                    <div class="car-card-main">
                        <img class="car-photo" src="${getPhoto(c)}" alt="">
                        <div class="car-info">
                            <div class="car-row1">
                                <span class="car-name">${getCarName(c)}</span>
                                <span class="deal-badge ${deal.badge}">${deal.label}</span>
                            </div>
                            <div class="car-row2">
                                <span class="${over ? 'price-over' : 'price-in'}">$${allInK}K total</span>
                                <span class="${c.km < 50000 ? 'km-low' : ''}">${Math.round(c.km/1000).toLocaleString()}K km</span>
                                <span>${c.distance}km away</span>
                            </div>
                            <div class="car-row1" style="margin-top:4px;">
                                <span class="car-dealer">${c.dealer}</span>
                                ${c.official ? '<span class="official-badge">Official Dealer</span>' : '<span style="color:#dc2626;font-size:12px;">(Used Car Lot)</span>'}
                            </div>
                            <div class="car-row2" style="margin-top:6px;">
                                <span class="carfax-badge ${cfx.cls}">${cfx.icon} CARFAX: ${cfx.label}</span>
                            </div>
                            ${c.carfaxNote ? `<div style="margin-top:6px;font-size:13px;color:#555;"><strong>Details:</strong> ${c.carfaxNote}</div>` : ''}
                            ${c.lastChecked ? `<div style="margin-top:4px;font-size:11px;color:#9ca3af;">Last verified: ${c.lastChecked}</div>` : ''}
                            <div class="car-row3">
                                ${feats.map(f => `<span class="feat">${feat[f]}</span>`).join('')}
                            </div>
                        </div>
                        <div class="car-actions" onclick="event.stopPropagation()">
                            ${listingUrl ? `<a href="${listingUrl}" target="_blank" class="btn btn-listing">View Listing</a>` : ''}
                            ${dealerUrl ? `<a href="${dealerUrl}" target="_blank" class="btn btn-small" style="background:#f0fdf4;color:#166534;border-color:#bbf7d0;">Dealer Site</a>` : ''}
                            ${c.carfaxUrl ? `<a href="${c.carfaxUrl}" target="_blank" class="btn btn-carfax">CARFAX</a>` : ''}
                            <a href="${getDirectionsUrl(c.dealer, c.address)}" target="_blank" class="btn btn-directions">Directions</a>
                            <button onclick="toggleFav(${c.id})" class="btn btn-save ${fav ? 'active' : ''}">${fav ? 'Saved' : 'Save'}</button>
                        </div>
                    </div>
                    <div class="car-notes">
                        ${note ? `<div class="note-display">${note}</div>` : ''}
                        <textarea class="note-input" placeholder="Write notes about this car..." data-id="${c.id}" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e5e5'">${note}</textarea>
                        <div class="note-actions">
                            <button class="btn btn-small btn-listing" onclick="saveNote(${c.id})">Save Note</button>
                            <button class="btn btn-small" style="background:#f3f4f6;color:#374151;" onclick="openEditModal(${c.id})">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="del(${c.id})">Remove</button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('s-total').textContent = cars.length;
            document.getElementById('s-budget').textContent = cars.filter(c => c.price * 1.13 <= 21000).length;
            document.getElementById('s-clean').textContent = cars.filter(c => c.carfax === 'clean').length;
        };

        const toggle = t => { filters[t] = !filters[t]; document.getElementById(`f-${t}`).classList.toggle('active', filters[t]); render(); };
        const toggleFav = async id => {
            if (favs.has(id)) { favs.delete(id); await db.from('favorites').delete().eq('car_id', id); }
            else { favs.add(id); await db.from('favorites').insert({ car_id: id }); }
            render();
        };
        const saveNote = async id => {
            const textarea = document.querySelector(`.note-input[data-id="${id}"]`);
            if (!textarea) return;
            const noteText = textarea.value.trim();
            notes[id] = noteText;
            await db.from('notes').upsert({ car_id: id, note: noteText }, { onConflict: 'car_id' });
            render();
            alert('Note saved!');
        };
        const del = async id => { if (confirm('Remove this car from your list?')) { await db.from('cars').delete().eq('id', id); cars = cars.filter(c => c.id !== id); render(); } };

        // Modal functions
        let editingCarId = null;

        const openAddModal = () => {
            editingCarId = null;
            document.getElementById('modal-title').textContent = 'Add New Car';
            document.getElementById('car-url').value = '';
            document.getElementById('car-year').value = '';
            document.getElementById('car-model').value = '';
            document.getElementById('car-price').value = '';
            document.getElementById('car-km').value = '';
            document.getElementById('car-dealer').value = '';
            document.getElementById('car-address').value = '';
            document.getElementById('car-distance').value = '';
            document.getElementById('car-color').value = '';
            document.getElementById('car-carfax').value = 'unknown';
            document.getElementById('car-official').value = 'true';
            document.getElementById('car-notes').value = '';
            document.getElementById('car-modal').classList.add('show');
        };

        const openEditModal = (id) => {
            const c = cars.find(car => car.id === id);
            if (!c) return;
            editingCarId = id;
            document.getElementById('modal-title').textContent = 'Edit Car';
            document.getElementById('car-url').value = c.listingUrl || '';
            document.getElementById('car-year').value = c.year || '';
            document.getElementById('car-model').value = c.model || '';
            document.getElementById('car-price').value = c.price || '';
            document.getElementById('car-km').value = c.km || '';
            document.getElementById('car-dealer').value = c.dealer || '';
            document.getElementById('car-address').value = c.address || '';
            document.getElementById('car-distance').value = c.distance || '';
            document.getElementById('car-color').value = c.color || '';
            document.getElementById('car-carfax').value = c.carfax || 'unknown';
            document.getElementById('car-official').value = c.official ? 'true' : 'false';
            document.getElementById('car-notes').value = c.carfaxNote || '';
            document.getElementById('car-modal').classList.add('show');
        };

        const closeModal = () => {
            document.getElementById('car-modal').classList.remove('show');
            editingCarId = null;
        };

        const saveCar = async () => {
            const year = parseInt(document.getElementById('car-year').value);
            const model = document.getElementById('car-model').value;
            const price = parseInt(document.getElementById('car-price').value);
            const km = parseInt(document.getElementById('car-km').value);
            const dealer = document.getElementById('car-dealer').value.trim();

            if (!year || !model || !price || !km || !dealer) {
                alert('Please fill in Year, Model, Price, Kilometers, and Dealer Name');
                return;
            }

            const carData = {
                year,
                model,
                price,
                km,
                dealer,
                color: document.getElementById('car-color').value || 'Unknown',
                address: document.getElementById('car-address').value || null,
                distance: parseInt(document.getElementById('car-distance').value) || 50,
                listing_url: document.getElementById('car-url').value || null,
                carfax: document.getElementById('car-carfax').value,
                carfax_note: document.getElementById('car-notes').value || null,
                official: document.getElementById('car-official').value === 'true',
                availability: 'available'
            };

            try {
                if (editingCarId) {
                    // Update existing car
                    const { data, error } = await db.from('cars').update(carData).eq('id', editingCarId).select();
                    if (error) throw error;
                    const idx = cars.findIndex(c => c.id === editingCarId);
                    if (idx >= 0 && data && data[0]) cars[idx] = mapCar(data[0]);
                    alert('Car updated!');
                } else {
                    // Insert new car
                    const { data, error } = await db.from('cars').insert(carData).select();
                    if (error) throw error;
                    if (data && data[0]) cars.push(mapCar(data[0]));
                    alert('Car added!');
                }
                closeModal();
                render();
                initMap();
            } catch (e) {
                console.error(e);
                alert('Error saving car: ' + e.message);
            }
        };

        const initMap = () => {
            map = L.map('map', { zoomControl: false }).setView(HOME_COORDS, 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.circleMarker(HOME_COORDS, { radius: 10, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 1, weight: 2 }).addTo(map).bindPopup('<b>Home</b>');
            cars.forEach(c => {
                if (c.coords) {
                    const col = c.carfax === 'clean' ? '#22c55e' : c.carfax === 'police' ? '#ef4444' : c.carfax === 'accident' ? '#f59e0b' : '#9ca3af';
                    L.circleMarker(c.coords, { radius: 6, color: col, fillColor: col, fillOpacity: 0.9, weight: 0 })
                        .addTo(map).bindPopup(`<b>${getShortName(c)}</b><br>$${c.price.toLocaleString()}`).on('click', () => selectCar(c.id));
                }
            });
        };

        const mapCar = c => ({ id: c.id, year: c.year, model: c.model, color: c.color, km: c.km, price: c.price, dealer: c.dealer, distance: c.distance, features: c.features || [], carfax: c.carfax, carfaxUrl: c.carfax_url, carfaxNote: c.carfax_note, listingUrl: c.listing_url, dealerUrl: c.dealer_url, address: c.address, coords: c.coords, official: c.official, lastChecked: c.last_checked });

        (async () => {
            try {
                const [carsRes, favsRes, notesRes] = await Promise.all([
                    db.from('cars').select('*'),
                    db.from('favorites').select('car_id'),
                    db.from('notes').select('car_id, note')
                ]);
                cars = (carsRes.data || []).map(mapCar);
                favs = new Set((favsRes.data || []).map(f => f.car_id));
                notes = (notesRes.data || []).reduce((a, n) => { a[n.car_id] = n.note; return a; }, {});
            } catch (e) { console.error(e); }
            render();
            initMap();
        })();
    </script>
</body>
</html>
