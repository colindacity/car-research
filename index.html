<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* Header */
        .header {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .stats { display: flex; gap: 12px; font-size: 13px; color: #666; }
        .stats strong { color: #333; }
        .header-actions { margin-left: auto; display: flex; gap: 8px; }
        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
        }
        .filter-btn:hover { background: #f5f5f5; }
        .filter-btn.active { background: #e3f2fd; border-color: #2196f3; }
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        /* Main layout */
        .layout { display: flex; min-height: calc(100vh - 57px); }
        .main { flex: 1; padding: 16px; overflow: auto; }
        .sidebar {
            width: 300px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        #map { flex: 1; min-height: 300px; }
        .map-info { padding: 12px; font-size: 13px; color: #666; border-top: 1px solid #eee; }

        /* Car cards */
        .cars { display: flex; flex-direction: column; gap: 12px; }
        .car-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s;
        }
        .car-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .car-card.fav { background: #fffbeb; }
        .car-card.hidden { display: none; }

        /* Status bar on left */
        .car-card.great { border-left: 4px solid #22c55e; }
        .car-card.good { border-left: 4px solid #3b82f6; }
        .car-card.ok { border-left: 4px solid #f59e0b; }
        .car-card.caution { border-left: 4px solid #ef4444; }
        .car-card.over { border-left: 4px solid #9ca3af; }

        /* Photo */
        .car-photo {
            width: 140px;
            height: 95px;
            border-radius: 8px;
            object-fit: cover;
            background: #e5e5e5;
            flex-shrink: 0;
        }

        /* Car info */
        .car-info { flex: 1; min-width: 0; }
        .car-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .car-title .score {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }
        .car-title .score.mid { background: #fff3e0; color: #e65100; }
        .car-title .score.low { background: #ffebee; color: #c62828; }
        .car-dealer { font-size: 13px; color: #666; margin-bottom: 8px; }
        .car-dealer .official { color: #2196f3; }

        /* Key stats row */
        .car-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .stat {
            display: flex;
            flex-direction: column;
        }
        .stat-value { font-size: 15px; font-weight: 600; }
        .stat-label { font-size: 11px; color: #999; }
        .stat-value.green { color: #22c55e; }
        .stat-value.red { color: #ef4444; }
        .stat-value.orange { color: #f59e0b; }

        /* Features row */
        .car-features {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .feat-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .feat-icon.yes { background: #e8f5e9; }

        /* CARFAX badge */
        .carfax-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .carfax-badge.clean { background: #e8f5e9; color: #2e7d32; }
        .carfax-badge.accident { background: #fff3e0; color: #e65100; }
        .carfax-badge.police { background: #ffebee; color: #c62828; }
        .carfax-badge.unknown { background: #f5f5f5; color: #757575; }

        /* Actions */
        .car-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            justify-content: space-between;
            min-width: 100px;
        }
        .view-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .view-btn:hover { background: #1976d2; }
        .action-row {
            display: flex;
            gap: 4px;
        }
        .icon-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: #f5f5f5; }
        .icon-btn.active { background: #fff3e0; border-color: #ffb74d; }

        /* Version */
        .version { position: fixed; bottom: 4px; left: 4px; font-size: 10px; color: #bbb; }

        /* Modal */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-bg.show { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }
        .modal h2 { font-size: 18px; margin-bottom: 16px; }
        .modal textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            margin-bottom: 16px;
        }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: white;
        }
        .modal-btn.primary { background: #2196f3; color: white; border-color: #2196f3; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .header { flex-wrap: wrap; gap: 8px; }
            .header h1 { font-size: 16px; }
            .stats { font-size: 12px; }
            .header-actions { width: 100%; justify-content: space-between; }
            .main { padding: 12px; }
            .car-card {
                flex-direction: column;
                padding: 12px;
                gap: 12px;
            }
            .car-photo {
                width: 100%;
                height: 160px;
            }
            .car-actions {
                flex-direction: row;
                width: 100%;
                min-width: auto;
            }
            .view-btn { flex: 1; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="version">v3.0 ¬∑ Dec 29</div>

    <div class="header">
        <h1>üöó Car Finder</h1>
        <div class="stats">
            <span><strong id="s-total">0</strong> cars</span>
            <span><strong id="s-budget">0</strong> in budget</span>
            <span><strong id="s-clean">0</strong> clean</span>
        </div>
        <div class="header-actions">
            <select id="sort" onchange="render()">
                <option value="score">Best Match</option>
                <option value="price">Lowest Price</option>
                <option value="km">Lowest KM</option>
                <option value="dist">Nearest</option>
            </select>
            <button class="filter-btn" id="f-fav" onclick="toggle('fav')">‚≠ê Favorites</button>
            <button class="filter-btn" id="f-budget" onclick="toggle('budget')">üí∞ Budget</button>
            <button class="filter-btn" id="f-clean" onclick="toggle('clean')">‚úì Clean</button>
        </div>
    </div>

    <div class="layout">
        <div class="main">
            <div class="cars" id="cars"></div>
        </div>
        <div class="sidebar">
            <div id="map"></div>
            <div class="map-info">
                <strong>Budget:</strong> $21K all-in (~$18.5K list)<br>
                <strong>Home:</strong> L4J 3W3 (Thornhill)
            </div>
        </div>
    </div>

    <div class="modal-bg" id="note-modal">
        <div class="modal">
            <h2>üìù Notes</h2>
            <textarea id="note-text" placeholder="Add your notes about this car..."></textarea>
            <div class="modal-actions">
                <button class="modal-btn" onclick="hideNoteModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveNoteModal()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = location.hostname === 'localhost' ? 'http://localhost:3001' : location.origin;
        let cars = [], favs = new Set(), notes = {}, filters = {}, editingNoteId = null;

        // Car silhouette SVG placeholders (always work)
        const soulSvg = `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100"><rect fill="#e8e8e8" width="200" height="100"/><path fill="#999" d="M30 70h140v8H30z"/><ellipse fill="#666" cx="55" cy="75" rx="15" ry="15"/><ellipse fill="#666" cx="145" cy="75" rx="15" ry="15"/><path fill="#aaa" d="M35 35h130c5 0 10 5 10 10v25H25V45c0-5 5-10 10-10z"/><path fill="#7cb" d="M45 40h50v20H40V45c0-3 2-5 5-5z"/><path fill="#7cb" d="M100 40h55c3 0 5 2 5 5v15h-60z"/><text x="100" y="95" text-anchor="middle" font-size="10" fill="#888">Kia Soul</text></svg>')}`;
        const venueSvg = `data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100"><rect fill="#e8e8e8" width="200" height="100"/><path fill="#999" d="M25 72h150v6H25z"/><ellipse fill="#666" cx="50" cy="74" rx="14" ry="14"/><ellipse fill="#666" cx="150" cy="74" rx="14" ry="14"/><path fill="#aaa" d="M30 38h140c6 0 10 4 10 10v24H20V48c0-6 4-10 10-10z"/><path fill="#89c" d="M40 42h45v18H35V47c0-3 2-5 5-5z"/><path fill="#89c" d="M90 42h60c3 0 5 2 5 5v13H90z"/><text x="100" y="95" text-anchor="middle" font-size="10" fill="#888">Hyundai Venue</text></svg>')}`;

        const getPhoto = c => c.model.includes('Soul') ? soulSvg : venueSvg;

        const getName = c => {
            const prefix = c.km < 30000 ? '‚≠ê Low KM ' : '';
            return `${prefix}${c.year} ${c.model}`;
        };

        const score = c => {
            let s = 0;
            s += Math.min(5, (c.features || []).length);
            s += c.km < 30000 ? 5 : c.km < 50000 ? 4 : c.km < 65000 ? 3 : c.km < 80000 ? 2 : 1;
            s += c.carfax === 'clean' ? 5 : c.carfax === 'unknown' ? 3 : 1;
            const allIn = c.price * 1.13;
            s += allIn < 18000 ? 5 : allIn < 20000 ? 4 : allIn < 21000 ? 3 : allIn < 22500 ? 2 : 1;
            s += c.distance < 20 ? 5 : c.distance < 50 ? 4 : c.distance < 100 ? 3 : 2;
            return s;
        };

        const status = (c, s) => {
            if (c.carfax === 'police' || c.carfax === 'accident') return 'caution';
            if (c.price * 1.13 > 21000) return 'over';
            return s >= 18 ? 'great' : s >= 15 ? 'good' : 'ok';
        };

        const render = () => {
            const sortBy = document.getElementById('sort').value;
            let list = [...cars];
            if (sortBy === 'score') list.sort((a, b) => score(b) - score(a));
            else if (sortBy === 'price') list.sort((a, b) => a.price - b.price);
            else if (sortBy === 'km') list.sort((a, b) => a.km - b.km);
            else if (sortBy === 'dist') list.sort((a, b) => a.distance - b.distance);

            const featIcons = {
                'htd-seats': 'üî•',
                'htd-wheel': '‚òÄÔ∏è',
                'camera': 'üì∑',
                'blind-spot': 'üëÅ',
                'lane': 'üõ£',
                'auto-brake': 'üõë'
            };
            const featOrder = ['htd-seats', 'htd-wheel', 'camera', 'blind-spot', 'lane', 'auto-brake'];

            document.getElementById('cars').innerHTML = list.map(c => {
                const s = score(c);
                const allIn = (c.price * 1.13 / 1000).toFixed(1);
                const over = c.price * 1.13 > 21000;
                const fav = favs.has(c.id);
                const hide = (filters.fav && !fav) || (filters.budget && over) || (filters.clean && c.carfax !== 'clean');
                const hasNote = notes[c.id];

                const carfaxLabel = c.carfax === 'clean' ? '‚úì Clean CARFAX'
                    : c.carfax === 'accident' ? '‚ö†Ô∏è Accident'
                    : c.carfax === 'police' ? '‚ùå Police Report'
                    : '? No CARFAX';

                return `
                <div class="car-card ${status(c, s)} ${fav ? 'fav' : ''} ${hide ? 'hidden' : ''}" data-id="${c.id}">
                    <img class="car-photo" src="${c.photoUrl || getPhoto(c)}" onerror="this.style.background='linear-gradient(135deg,#e0e0e0,#f5f5f5)'">

                    <div class="car-info">
                        <div class="car-title">
                            ${getName(c)}
                            <span class="score ${s >= 18 ? '' : s >= 14 ? 'mid' : 'low'}">${s}/25</span>
                        </div>
                        <div class="car-dealer">
                            ${c.dealer}${c.official ? ' <span class="official">‚òÖ Official</span>' : ''}
                            ${c.color && c.color !== 'Unknown' ? ` ¬∑ ${c.color}` : ''}
                        </div>

                        <div class="car-stats">
                            <div class="stat">
                                <span class="stat-value ${over ? 'red' : 'green'}">$${allIn}K</span>
                                <span class="stat-label">all-in</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">${(c.km/1000).toFixed(0)}K</span>
                                <span class="stat-label">km</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">${c.distance}km</span>
                                <span class="stat-label">away</span>
                            </div>
                            <div class="stat">
                                <span class="carfax-badge ${c.carfax}">${carfaxLabel}</span>
                            </div>
                        </div>

                        <div class="car-features">
                            ${featOrder.filter(f => (c.features || []).includes(f)).map(f => `<div class="feat-icon yes" title="${f}">${featIcons[f]}</div>`).join('') || '<span style="color:#999;font-size:11px">No extras</span>'}
                        </div>
                    </div>

                    <div class="car-actions">
                        ${c.listingUrl ? `<a href="${c.listingUrl}" target="_blank" class="view-btn">View Listing</a>` : '<span></span>'}
                        <div class="action-row">
                            <button class="icon-btn ${fav ? 'active' : ''}" onclick="toggleFav(${c.id})" title="Favorite">‚≠ê</button>
                            <button class="icon-btn ${hasNote ? 'active' : ''}" onclick="showNoteModal(${c.id})" title="Notes">üìù</button>
                            ${c.carfaxUrl ? `<a href="${c.carfaxUrl}" target="_blank" class="icon-btn" title="CARFAX">üìã</a>` : ''}
                            <button class="icon-btn" onclick="del(${c.id})" title="Remove">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('s-total').textContent = cars.length;
            document.getElementById('s-budget').textContent = cars.filter(c => c.price * 1.13 <= 21000).length;
            document.getElementById('s-clean').textContent = cars.filter(c => c.carfax === 'clean').length;
        };

        const toggle = t => {
            filters[t] = !filters[t];
            document.getElementById(`f-${t}`).classList.toggle('active', filters[t]);
            render();
        };

        const toggleFav = async id => {
            favs.has(id) ? favs.delete(id) : favs.add(id);
            await fetch(`${API}/favorites`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify([...favs]) });
            render();
        };

        const showNoteModal = id => {
            editingNoteId = id;
            document.getElementById('note-text').value = notes[id] || '';
            document.getElementById('note-modal').classList.add('show');
            document.getElementById('note-text').focus();
        };
        const hideNoteModal = () => document.getElementById('note-modal').classList.remove('show');
        const saveNoteModal = async () => {
            notes[editingNoteId] = document.getElementById('note-text').value;
            await fetch(`${API}/notes`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(notes) });
            hideNoteModal();
            render();
        };

        const del = async id => {
            if (confirm('Remove this car from your list?')) {
                await fetch(`${API}/cars/${id}`, { method: 'DELETE' });
                cars = cars.filter(c => c.id !== id);
                render();
            }
        };

        const initMap = () => {
            const map = L.map('map', { zoomControl: false }).setView([43.8, -79.45], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.circleMarker([43.8108, -79.4250], { radius: 8, color: '#2196f3', fillColor: '#2196f3', fillOpacity: 1, weight: 2 }).addTo(map).bindPopup('üè† Home');
            cars.forEach(c => {
                if (c.coords) {
                    const col = c.carfax === 'clean' ? '#22c55e' : c.carfax === 'police' ? '#ef4444' : c.carfax === 'accident' ? '#f59e0b' : '#9ca3af';
                    L.circleMarker(c.coords, { radius: 6, color: col, fillColor: col, fillOpacity: 0.8, weight: 0 })
                        .addTo(map).bindPopup(`<strong>${c.year} ${c.model}</strong><br>$${c.price.toLocaleString()}`);
                }
            });
        };

        (async () => {
            try {
                const [cRes, fRes, nRes] = await Promise.all([
                    fetch(`${API}/cars`),
                    fetch(`${API}/favorites`),
                    fetch(`${API}/notes`)
                ]);
                cars = await cRes.json();
                favs = new Set(await fRes.json());
                notes = await nRes.json();
            } catch (e) { console.error(e); }
            render();
            initMap();
        })();
    </script>
</body>
</html>
