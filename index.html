<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Search - Mom's Car Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #fafafa;
            --card: #ffffff;
            --fg: #1a1a1a;
            --muted: #666;
            --border: #e0e0e0;
            --accent: #1a73e8;
            --green: #0d7a0d;
            --orange: #e65100;
            --red: #c62828;
            --yellow: #ffc107;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 18px;
            color: var(--fg);
            background: var(--bg);
            line-height: 1.5;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Header */
        header {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        h1 { font-size: 28px; font-weight: 600; margin-bottom: 8px; }
        .subtitle { color: var(--muted); font-size: 16px; }
        .budget-badge {
            display: inline-block;
            background: #e8f5e9;
            color: var(--green);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            margin-top: 12px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #1557b0; }
        .btn-secondary { background: var(--card); color: var(--fg); border: 2px solid var(--border); }
        .btn-secondary:hover { background: #f5f5f5; }
        .btn-secondary.active { background: #e3f2fd; border-color: var(--accent); }

        select, input[type="text"], input[type="url"] {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--card);
        }
        select:focus, input:focus { outline: none; border-color: var(--accent); }

        /* Stats */
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat {
            background: var(--card);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 14px; color: var(--muted); }

        /* Map */
        #map {
            height: 200px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Car Cards */
        .car-grid {
            display: grid;
            gap: 16px;
        }
        .car-card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 6px solid var(--green);
            transition: all 0.2s;
            cursor: pointer;
        }
        .car-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .car-card.accident { border-left-color: var(--orange); }
        .car-card.police-accident { border-left-color: var(--red); }
        .car-card.over-budget { border-left-color: var(--muted); }
        .car-card.favorite { background: #fffde7; }
        .car-card.hidden { display: none; }

        .car-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .car-title { font-size: 22px; font-weight: 600; }
        .car-subtitle { font-size: 14px; color: var(--muted); }

        .car-score {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            min-width: 80px;
        }
        .car-score.high { color: var(--green); }
        .car-score.mid { color: var(--orange); }
        .car-score.low { color: var(--red); }
        .car-score small { display: block; font-size: 12px; font-weight: 400; color: var(--muted); }

        .car-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .detail-item {
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
        }
        .detail-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-value { font-size: 20px; font-weight: 600; }
        .detail-value.green { color: var(--green); }
        .detail-value.red { color: var(--red); }
        .detail-value.orange { color: var(--orange); }

        .features {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .feature {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .feature.key { background: #e8f5e9; color: var(--green); }
        .feature.yes { background: #e3f2fd; color: var(--accent); }
        .feature.neutral { background: #f5f5f5; color: var(--muted); }

        .car-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            gap: 12px;
            flex-wrap: wrap;
        }
        .car-links a {
            margin-right: 16px;
            font-size: 16px;
            font-weight: 500;
        }
        .car-actions {
            display: flex;
            gap: 8px;
        }
        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--card);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: #f5f5f5; }
        .icon-btn.starred { background: #fff8e1; border-color: var(--yellow); color: var(--yellow); }

        /* Notes */
        .car-notes {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--border);
        }
        .notes-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }
        .notes-input:focus { outline: none; border-color: var(--accent); }

        /* Add Car Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--card);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h2 { font-size: 24px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--muted); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* CARFAX Status */
        .carfax-status { padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .carfax-status.clean { background: #e8f5e9; }
        .carfax-status.accident { background: #fff3e0; }
        .carfax-status.police { background: #ffebee; }
        .carfax-status.unknown { background: #f5f5f5; }

        /* Comparison Table */
        .comparison {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .comparison h3 { font-size: 20px; margin-bottom: 16px; }
        .comparison table { width: 100%; font-size: 16px; border-collapse: collapse; }
        .comparison th, .comparison td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .comparison th { color: var(--muted); font-weight: 500; }

        /* Responsive - Modern Compact Mobile */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .container { padding: 12px; }

            /* Compact header */
            header { padding: 12px; margin-bottom: 12px; }
            h1 { font-size: 20px; margin-bottom: 4px; }
            .subtitle { font-size: 12px; }
            .budget-badge { font-size: 13px; padding: 6px 10px; margin-top: 8px; }

            /* Horizontal scroll stats */
            .stats {
                gap: 8px;
                margin-bottom: 12px;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 4px;
            }
            .stat {
                padding: 10px 14px;
                min-width: fit-content;
                flex-shrink: 0;
            }
            .stat-value { font-size: 20px; }
            .stat-label { font-size: 11px; }

            /* Compact toolbar - horizontal scroll */
            .toolbar {
                gap: 8px;
                margin-bottom: 12px;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 4px;
            }
            .btn {
                padding: 8px 12px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            select {
                padding: 8px 10px;
                font-size: 13px;
                min-width: 140px;
            }

            /* Hide map on mobile - save space */
            #map { display: none; }

            /* Compact cards */
            .car-grid { gap: 10px; }
            .car-card {
                padding: 12px;
                border-left-width: 4px;
                border-radius: 8px;
            }
            .car-header { margin-bottom: 8px; }
            .car-title { font-size: 16px; }
            .car-subtitle { font-size: 11px; }
            .car-score {
                font-size: 22px;
                min-width: 50px;
            }
            .car-score small { font-size: 10px; }

            /* Inline details - 2x2 grid */
            .car-details {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-bottom: 10px;
            }
            .detail-item { padding: 8px; border-radius: 6px; }
            .detail-label { font-size: 10px; }
            .detail-value { font-size: 15px; }

            /* Compact CARFAX */
            .carfax-status {
                padding: 8px;
                margin-bottom: 8px;
                font-size: 13px;
                border-radius: 6px;
            }
            .carfax-status div { font-size: 11px !important; }

            /* Compact features - smaller pills */
            .features { gap: 4px; margin-bottom: 10px; }
            .feature {
                padding: 4px 8px;
                font-size: 11px;
                border-radius: 12px;
            }

            /* Compact footer */
            .car-footer {
                padding-top: 10px;
                gap: 8px;
            }
            .car-links a {
                font-size: 13px;
                margin-right: 12px;
            }
            .icon-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            /* Smaller notes */
            .car-notes { margin-top: 8px; padding-top: 8px; }
            .notes-input {
                padding: 8px;
                font-size: 13px;
                min-height: 40px;
            }

            /* Modal adjustments */
            .modal { padding: 20px; }
            .modal h2 { font-size: 18px; margin-bottom: 16px; }
            .form-group { margin-bottom: 14px; }
            .form-group label { font-size: 12px; margin-bottom: 4px; }
            .form-group input, .form-group select, .form-group textarea {
                padding: 10px;
                font-size: 14px;
            }
            .form-row { grid-template-columns: 1fr; gap: 10px; }

            /* Comparison table scroll */
            .comparison { padding: 12px; overflow-x: auto; }
            .comparison h3 { font-size: 16px; }
            .comparison table { font-size: 13px; min-width: 500px; }
            .comparison th, .comparison td { padding: 8px; }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            .car-details { grid-template-columns: 1fr 1fr; }
            .detail-value { font-size: 14px; }
            .car-title { font-size: 15px; }
            .budget-badge { font-size: 12px; }
        }

        /* Version badge */
        .version {
            position: fixed;
            bottom: 8px;
            left: 8px;
            font-size: 11px;
            color: #999;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
        }

        /* Print */
        @media print {
            .toolbar, .modal-overlay, .icon-btn, .btn { display: none; }
            .car-card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="version">v1.2 ¬∑ Dec 30 1:05am</div>
    <div class="container">
        <header>
            <h1>üöó Mom's Car Finder</h1>
            <p class="subtitle">Kia Soul & Hyundai Venue in the GTA ‚Ä¢ Dealer Only ‚Ä¢ Updated Dec 2024</p>
            <div class="budget-badge">üí∞ Budget: $21,000 all-in (max ~$17,500 sticker)</div>
        </header>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="total-cars">0</div>
                <div class="stat-label">Total Cars</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="in-budget">0</div>
                <div class="stat-label">In Budget</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="clean-carfax">0</div>
                <div class="stat-label">Clean CARFAX</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="favorites-count">0</div>
                <div class="stat-label">‚≠ê Favorites</div>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="showAddModal()">‚ûï Add New Car</button>
            <select id="sort-select" onchange="sortCars()">
                <option value="score">Sort by: Best Rating</option>
                <option value="price">Sort by: Lowest Price</option>
                <option value="km">Sort by: Lowest KM</option>
                <option value="distance">Sort by: Closest</option>
                <option value="year">Sort by: Newest Year</option>
            </select>
            <button class="btn btn-secondary" id="filter-favorites" onclick="toggleFavorites()">‚≠ê Show Favorites Only</button>
            <button class="btn btn-secondary" id="filter-budget" onclick="toggleBudget()">üí∞ In Budget Only</button>
            <button class="btn btn-secondary" onclick="showComparison()">üìä Compare Soul vs Venue</button>
        </div>

        <div id="map"></div>

        <div class="car-grid" id="car-grid">
            <!-- Cars will be rendered here by JavaScript -->
        </div>

        <!-- Comparison Section -->
        <div class="comparison" id="comparison" style="display: none;">
            <h3>Soul vs Venue Comparison</h3>
            <table>
                <tr><th>Spec</th><th>Kia Soul</th><th>Hyundai Venue</th></tr>
                <tr><td><strong>Cargo (seats up)</strong></td><td style="color:var(--green)"><strong>24.2 cu.ft.</strong></td><td>18.7 cu.ft.</td></tr>
                <tr><td><strong>Cargo (folded)</strong></td><td style="color:var(--green)"><strong>61-62 cu.ft.</strong></td><td>31.9 cu.ft.</td></tr>
                <tr><td><strong>Length</strong></td><td>165.2"</td><td style="color:var(--green)"><strong>159.1"</strong> (easier parking)</td></tr>
                <tr><td><strong>Turning Radius</strong></td><td>17.4 ft</td><td style="color:var(--green)"><strong>16.7 ft</strong> (tighter)</td></tr>
                <tr><td><strong>Brakes</strong></td><td>4-wheel disc</td><td>Front disc / rear drum</td></tr>
                <tr><td><strong>Auto-Brake</strong></td><td>2022+ EX: Standard<br>2017-19: Rare</td><td style="color:var(--green)"><strong>All trims: Standard</strong></td></tr>
                <tr><td><strong>Reliability</strong></td><td>JD Power 84-86</td><td>JD Power 80-85</td></tr>
            </table>
            <p style="margin-top: 16px; color: var(--muted);">
                <strong>Bottom line:</strong> Soul has 2x cargo space. Venue is easier to park with standard auto-brake on all trims. Avoid Soul 2020-21 (CVT issues).
            </p>
        </div>
    </div>

    <!-- Add Car Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal">
            <h2>‚ûï Add New Car</h2>
            <div class="form-group">
                <label>üîó Paste AutoTrader or Dealer URL (auto-fill)</label>
                <input type="url" id="car-url" placeholder="https://www.autotrader.ca/a/..." onpaste="handleUrlPaste(event)">
                <p style="font-size: 14px; color: var(--muted); margin-top: 8px;">Paste a URL and we'll try to auto-fill the details!</p>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
            <div class="form-row">
                <div class="form-group">
                    <label>Year</label>
                    <select id="car-year">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022" selected>2022</option>
                        <option value="2021">2021</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                        <option value="2017">2017</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Make & Model</label>
                    <select id="car-model">
                        <option value="Soul EX">Kia Soul EX</option>
                        <option value="Soul EX+">Kia Soul EX+</option>
                        <option value="Soul +">Kia Soul +</option>
                        <option value="Venue Essential">Hyundai Venue Essential</option>
                        <option value="Venue Preferred">Hyundai Venue Preferred</option>
                        <option value="Venue Ultimate">Hyundai Venue Ultimate</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Kilometers</label>
                    <input type="text" id="car-km" placeholder="e.g. 45000">
                </div>
                <div class="form-group">
                    <label>List Price ($)</label>
                    <input type="text" id="car-price" placeholder="e.g. 17500">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Dealer Name</label>
                    <input type="text" id="car-dealer" placeholder="e.g. Thornhill Hyundai">
                </div>
                <div class="form-group">
                    <label>Distance (km)</label>
                    <input type="text" id="car-distance" placeholder="e.g. 15">
                </div>
            </div>
            <div class="form-group">
                <label>Color</label>
                <input type="text" id="car-color" placeholder="e.g. White">
            </div>
            <div class="form-group">
                <label>Features (check all that apply)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                    <label><input type="checkbox" id="feat-htd-seats"> Heated Seats</label>
                    <label><input type="checkbox" id="feat-htd-wheel"> Heated Wheel</label>
                    <label><input type="checkbox" id="feat-camera"> Backup Camera</label>
                    <label><input type="checkbox" id="feat-blind-spot"> Blind Spot</label>
                    <label><input type="checkbox" id="feat-lane"> Lane Assist</label>
                    <label><input type="checkbox" id="feat-auto-brake"> Auto-Brake</label>
                </div>
            </div>
            <div class="form-group">
                <label>CARFAX Status</label>
                <select id="car-carfax">
                    <option value="clean">‚úÖ Clean - No Accidents</option>
                    <option value="unknown">‚ùì Unknown / Not Checked</option>
                    <option value="accident">‚ö†Ô∏è Minor Accident</option>
                    <option value="police">üö® Police Reported Accident</option>
                </select>
            </div>
            <div class="form-group">
                <label>CARFAX Link (optional)</label>
                <input type="url" id="car-carfax-url" placeholder="https://vhr.carfax.ca/?id=...">
            </div>
            <div class="form-group">
                <label>Listing URL</label>
                <input type="url" id="car-listing-url" placeholder="https://www.autotrader.ca/...">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="car-notes" rows="3" placeholder="Any notes about this car..."></textarea>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addCar()">Add Car</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // API endpoint - auto-detect local vs deployed
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3001'
            : window.location.origin;

        // State
        let cars = [];
        let favorites = new Set();
        let notes = {};
        let showFavoritesOnly = false;
        let showBudgetOnly = false;

        // Load from API
        async function loadState() {
            try {
                const [carsRes, favRes, notesRes] = await Promise.all([
                    fetch(`${API_URL}/cars`),
                    fetch(`${API_URL}/favorites`),
                    fetch(`${API_URL}/notes`)
                ]);
                cars = await carsRes.json();
                const favData = await favRes.json();
                favorites = new Set(favData);
                notes = await notesRes.json();
            } catch (err) {
                console.error('API not available, using empty state:', err.message);
                cars = [];
                favorites = new Set();
                notes = {};
            }
        }

        // Save favorites to API
        async function saveFavorites() {
            try {
                await fetch(`${API_URL}/favorites`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([...favorites])
                });
            } catch (err) {
                console.error('Failed to save favorites:', err);
            }
        }

        // Save notes to API
        async function saveNotes() {
            try {
                await fetch(`${API_URL}/notes`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(notes)
                });
            } catch (err) {
                console.error('Failed to save notes:', err);
            }
        }

        // Calculate score
        function calculateScore(car) {
            let score = 0;
            // Features (5 pts)
            const keyFeatures = ['htd-seats', 'camera', 'blind-spot', 'lane', 'htd-wheel'];
            score += Math.min(5, car.features.filter(f => keyFeatures.includes(f)).length);
            // KM (5 pts)
            if (car.km < 30000) score += 5;
            else if (car.km < 50000) score += 4;
            else if (car.km < 65000) score += 3;
            else if (car.km < 80000) score += 2;
            else score += 1;
            // CARFAX (5 pts)
            if (car.carfax === 'clean') score += 5;
            else if (car.carfax === 'unknown') score += 3;
            else if (car.carfax === 'accident') score += 2;
            // Price (5 pts)
            const allIn = car.price * 1.13;
            if (allIn < 18000) score += 5;
            else if (allIn < 20000) score += 4;
            else if (allIn < 21000) score += 3;
            else if (allIn < 22500) score += 2;
            else score += 1;
            // Distance (5 pts)
            if (car.distance < 20) score += 5;
            else if (car.distance < 50) score += 4;
            else if (car.distance < 100) score += 3;
            else if (car.distance < 150) score += 2;
            else score += 1;
            return score;
        }

        // Get all-in price
        function getAllIn(price) {
            return Math.round(price * 1.13 / 100) / 10;
        }

        // Format KM
        function formatKm(km) {
            return (km / 1000).toFixed(0) + 'K';
        }

        // Get car type
        function getCarType(model) {
            return model.includes('Soul') ? 'Soul' : 'Venue';
        }

        // Render cars
        function renderCars() {
            const grid = document.getElementById('car-grid');
            const sortBy = document.getElementById('sort-select').value;

            // Sort
            let sorted = [...cars];
            if (sortBy === 'score') sorted.sort((a, b) => calculateScore(b) - calculateScore(a));
            else if (sortBy === 'price') sorted.sort((a, b) => a.price - b.price);
            else if (sortBy === 'km') sorted.sort((a, b) => a.km - b.km);
            else if (sortBy === 'distance') sorted.sort((a, b) => a.distance - b.distance);
            else if (sortBy === 'year') sorted.sort((a, b) => b.year - a.year);

            grid.innerHTML = sorted.map(car => {
                const score = calculateScore(car);
                const allIn = getAllIn(car.price);
                const isFavorite = favorites.has(car.id);
                const note = notes[car.id] || '';
                const isOverBudget = allIn > 21;
                const isAccident = car.carfax === 'accident';
                const isPolice = car.carfax === 'police';

                // Filter
                let hidden = false;
                if (showFavoritesOnly && !isFavorite) hidden = true;
                if (showBudgetOnly && isOverBudget) hidden = true;

                const featureLabels = {
                    'htd-seats': 'Heated Seats',
                    'htd-wheel': 'Heated Wheel',
                    'camera': 'Backup Camera',
                    'blind-spot': 'Blind Spot',
                    'lane': 'Lane Assist',
                    'auto-brake': 'Auto-Brake'
                };

                return `
                    <div class="car-card ${isAccident ? 'accident' : ''} ${isPolice ? 'police-accident' : ''} ${isOverBudget ? 'over-budget' : ''} ${isFavorite ? 'favorite' : ''} ${hidden ? 'hidden' : ''}" data-id="${car.id}">
                        <div class="car-header">
                            <div>
                                <div class="car-title">${car.year} ${car.model}</div>
                                <div class="car-subtitle">${car.color} ‚Ä¢ ${car.dealer}${car.official ? ' ‚≠ê Official Dealer' : ''}</div>
                            </div>
                            <div class="car-score ${score >= 18 ? 'high' : score >= 14 ? 'mid' : 'low'}">
                                ${score}<small>/25</small>
                            </div>
                        </div>

                        <div class="car-details">
                            <div class="detail-item">
                                <div class="detail-label">Kilometers</div>
                                <div class="detail-value ${car.km < 50000 ? 'green' : car.km > 80000 ? 'orange' : ''}">${formatKm(car.km)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">List Price</div>
                                <div class="detail-value">$${car.price.toLocaleString()}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">All-In (w/tax)</div>
                                <div class="detail-value ${allIn <= 21 ? 'green' : 'orange'}">~$${allIn}K</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Distance</div>
                                <div class="detail-value">${car.distance} km</div>
                            </div>
                        </div>

                        <div class="carfax-status ${car.carfax}">
                            ${car.carfax === 'clean' ? '‚úÖ Clean CARFAX - No Accidents' : ''}
                            ${car.carfax === 'unknown' ? '‚ùì CARFAX Not Verified' : ''}
                            ${car.carfax === 'accident' ? '‚ö†Ô∏è Accident on Record' : ''}
                            ${car.carfax === 'police' ? 'üö® Police Reported Accident' : ''}
                            ${car.carfaxNote ? `<div style="font-size: 14px; margin-top: 4px;">${car.carfaxNote}</div>` : ''}
                        </div>

                        <div class="features">
                            ${car.features.map(f => `<span class="feature ${['htd-seats', 'camera', 'blind-spot', 'lane'].includes(f) ? 'key' : 'yes'}">${featureLabels[f] || f}</span>`).join('')}
                        </div>

                        <div class="car-footer">
                            <div class="car-links">
                                ${car.listingUrl ? `<a href="${car.listingUrl}" target="_blank">üìã View Listing</a>` : ''}
                                ${car.carfaxUrl ? `<a href="${car.carfaxUrl}" target="_blank">üìÑ CARFAX</a>` : ''}
                            </div>
                            <div class="car-actions">
                                <button class="icon-btn ${isFavorite ? 'starred' : ''}" onclick="toggleFavorite(${car.id})" title="Favorite">‚≠ê</button>
                                <button class="icon-btn" onclick="deleteCar(${car.id})" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>

                        <div class="car-notes">
                            <textarea class="notes-input" placeholder="Add your notes here..." onchange="saveNote(${car.id}, this.value)">${note}</textarea>
                        </div>
                    </div>
                `;
            }).join('');

            updateStats();
        }

        // Update stats
        function updateStats() {
            document.getElementById('total-cars').textContent = cars.length;
            document.getElementById('in-budget').textContent = cars.filter(c => getAllIn(c.price) <= 21).length;
            document.getElementById('clean-carfax').textContent = cars.filter(c => c.carfax === 'clean').length;
            document.getElementById('favorites-count').textContent = favorites.size;
        }

        // Toggle favorite
        async function toggleFavorite(id) {
            if (favorites.has(id)) favorites.delete(id);
            else favorites.add(id);
            await saveFavorites();
            renderCars();
        }

        // Save note
        async function saveNote(id, note) {
            notes[id] = note;
            await saveNotes();
        }

        // Delete car
        async function deleteCar(id) {
            if (confirm('Are you sure you want to remove this car?')) {
                try {
                    await fetch(`${API_URL}/cars/${id}`, { method: 'DELETE' });
                    cars = cars.filter(c => c.id !== id);
                    renderCars();
                } catch (err) {
                    console.error('Failed to delete car:', err);
                }
            }
        }

        // Sort
        function sortCars() {
            renderCars();
        }

        // Toggle favorites filter
        function toggleFavorites() {
            showFavoritesOnly = !showFavoritesOnly;
            document.getElementById('filter-favorites').classList.toggle('active', showFavoritesOnly);
            renderCars();
        }

        // Toggle budget filter
        function toggleBudget() {
            showBudgetOnly = !showBudgetOnly;
            document.getElementById('filter-budget').classList.toggle('active', showBudgetOnly);
            renderCars();
        }

        // Show comparison
        function showComparison() {
            const comp = document.getElementById('comparison');
            comp.style.display = comp.style.display === 'none' ? 'block' : 'none';
        }

        // Add car modal
        function showAddModal() {
            document.getElementById('add-modal').classList.add('show');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('show');
            // Clear form
            document.getElementById('car-url').value = '';
            document.getElementById('car-km').value = '';
            document.getElementById('car-price').value = '';
            document.getElementById('car-dealer').value = '';
            document.getElementById('car-distance').value = '';
            document.getElementById('car-color').value = '';
            document.getElementById('car-carfax-url').value = '';
            document.getElementById('car-listing-url').value = '';
            document.getElementById('car-notes').value = '';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // Handle URL paste for auto-fill
        function handleUrlPaste(e) {
            setTimeout(() => {
                const url = e.target.value;
                if (url.includes('autotrader.ca') || url.includes('carfax.ca')) {
                    alert('üîç URL detected! For now, please fill in the details manually. Auto-scraping requires a server.\n\nTip: Open the URL in another tab and copy the details.');
                }
            }, 100);
        }

        // Add car
        async function addCar() {
            const newCar = {
                year: parseInt(document.getElementById('car-year').value),
                model: document.getElementById('car-model').value,
                color: document.getElementById('car-color').value || 'Unknown',
                km: parseInt(document.getElementById('car-km').value) || 0,
                price: parseInt(document.getElementById('car-price').value) || 0,
                dealer: document.getElementById('car-dealer').value || 'Unknown',
                distance: parseInt(document.getElementById('car-distance').value) || 0,
                features: [],
                carfax: document.getElementById('car-carfax').value,
                carfaxUrl: document.getElementById('car-carfax-url').value,
                listingUrl: document.getElementById('car-listing-url').value,
                carfaxNote: '',
                coords: [43.8, -79.4], // Default to GTA center
                official: false
            };

            // Collect features
            if (document.getElementById('feat-htd-seats').checked) newCar.features.push('htd-seats');
            if (document.getElementById('feat-htd-wheel').checked) newCar.features.push('htd-wheel');
            if (document.getElementById('feat-camera').checked) newCar.features.push('camera');
            if (document.getElementById('feat-blind-spot').checked) newCar.features.push('blind-spot');
            if (document.getElementById('feat-lane').checked) newCar.features.push('lane');
            if (document.getElementById('feat-auto-brake').checked) newCar.features.push('auto-brake');

            try {
                const res = await fetch(`${API_URL}/cars`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newCar)
                });
                const savedCar = await res.json();
                cars.push(savedCar);

                // Add initial note if provided
                const initialNote = document.getElementById('car-notes').value;
                if (initialNote) {
                    notes[savedCar.id] = initialNote;
                    await saveNotes();
                }

                renderCars();
                closeAddModal();
            } catch (err) {
                console.error('Failed to add car:', err);
                alert('Failed to add car. Make sure the server is running.');
            }
        }

        // Initialize map
        function initMap() {
            const map = L.map('map', { zoomControl: false }).setView([43.75, -79.5], 9);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

            // Home marker
            L.circleMarker([43.8108, -79.4250], { radius: 8, color: '#1a73e8', fillColor: '#1a73e8', fillOpacity: 1, weight: 0 })
                .addTo(map).bindPopup('<strong>üè† Home</strong><br>L4J 3W3');

            // Car markers
            cars.forEach(car => {
                if (car.coords) {
                    const color = car.carfax === 'clean' ? '#0d7a0d' : car.carfax === 'police' ? '#c62828' : car.carfax === 'accident' ? '#e65100' : '#666';
                    L.circleMarker(car.coords, { radius: 6, color, fillColor: color, fillOpacity: 0.8, weight: 0 })
                        .addTo(map).bindPopup(`<strong>${car.year} ${car.model}</strong><br>${car.dealer}<br>$${car.price.toLocaleString()}`);
                }
            });
        }

        // Initialize
        async function init() {
            await loadState();
            renderCars();
            initMap();
        }
        init();
    </script>
</body>
</html>
